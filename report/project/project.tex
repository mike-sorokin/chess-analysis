\chapter{Implementation}

\section{Lichess.org Puzzle Database}

\subsection{Overview}

This project requires access to various examples of chess puzzles with
pre-defined difficulties and themes. Fortunately, the lichess puzzle
database,\cite{lichessPuzzles} which was also mentioned in the previous
section, provides approximately 3.8 million chess puzzles which have been
generated from user games played on lichess. These puzzles are stored in FEN
format, with a reference to the game where they appeared. They also contain the
solution as a string moves, the tactics tags,\cite{lichessXML} and the puzzle
rating, along with other metadata.

An example puzzle string is shown below. This puzzle is also shown in the two
figures below, Figure \ref{puzzle1} and \ref{puzzle2}.

\begin{verbatim}
q3k1nr/1pp1nQpp/3p4/1P2p3/4P3/B1PP1b2/B5PP/5K2 b k - 0 17,
e8d7 a2e6 d7d8 f7f8,1760,80,83,72,mate mateIn2 middlegame short,
https://lichess.org/yyznGmXs/black#34,
Italian_Game Italian_Game_Classical_Variation
\end{verbatim}

\begin{figure}[H]
    \begin{minipage}{0.475\textwidth}
        \centering
        \chessboard[setfen=q3k1nr/1pp1nQpp/3p4/1P2p3/4P3/B1PP1b2/B5PP/5K2 b k - 0 17]
        \caption{\textbf{ZensAlviani -- desso2b}, lichess.org Blitz game, move 17.}
        \label{puzzle1}
    \end{minipage}
    \hspace{0.05\textwidth}
    \begin{minipage}{0.475\textwidth}
        \centering
        \chessboard[setfen=q5nr/1ppknQpp/3p4/1P2p3/4P3/B1PP1b2/B5PP/5K2 w - - 1 18]
        \caption{\textbf{ZensAlviani -- desso2b}, lichess.org Blitz game, move 18.
        Checkmate is imminent with \texttt{18.Be6+ Kd8 19.Qf8\#}.}
        \label{puzzle2}
    \end{minipage}
\end{figure}

Processing these is a trivial task with one small detail: the given FEN strings
are the state of the game right before the critical blunder is played by the
opposing site. This means the puzzle, as shown to the user, is the position
after the first move has been played. Fortunately, processing this data is made
simple with the python-chess library.\cite{pythonChess}

\subsection{Data Exploration}

The lichess puzzle database has approximately 3.8 million rated and tagged
chess puzzles. Initially, they were automatically
processed,\cite{lichessTagger} but were then refined with user
feedback.\cite{lichessPuzzles} This also allowed the puzzles to obtain a
rating, which is indicative of its difficulty.\cite{lichessPuzzles}

Overall, there are 60 various puzzle themes.\cite{lichessXML} Figure
\ref{dataThemeCounts} shows the counts of each theme in all of the contained
puzzles. It should be noted that some themes are mutually exclusive (a
checkmate puzzle cannot be both \emph{mate-in-one} and \emph{mate-in-two}).

The most common puzzle themes are the most general ones -- specifically
`short', `middlegame', and `endgame'. There is a lot of variation in how
frequent the various patterns are, which is a natural consequence of the game.

\begin{figure}
    \centering
    \includegraphics[width=0.9\linewidth]{project/img/puzzle_theme_counts.png}
    \caption{Frequency of puzzle themes in the lichess.org puzzle database.\cite{lichessPuzzles}}
    \label{dataThemeCounts}
\end{figure}

Figure \ref{dataHistogram}, shown below, shows the distribution of ratings
across the chess puzzles. It should be noted that these ratings are only
appropriate within this dataset, and cannot be compared to ratings of puzzles
on other chess websites. The puzzle ratings are quite symmetric about the mean,
and this is of course a result of Glickman's Glicko2 rating
system.\cite{glicko}

When analysing the rating distribution by theme, an expected behaviour occurs.
Some chess tactics patterns are considerably simpler to spot, meaning a weaker
player is able to solve the puzzle with that theme. Therefore some puzzle
themes, \emph{back-rank mate}, for example, have lower-rated puzzles when
compared to puzzles featuring a \emph{trapped piece} or \emph{defensive
move}\footnote{Notoriously difficult for humans, who are usually much better at
aggression than defense.}.

Shown in Figures \ref{puzzle3} and \ref{puzzle4} are examples of some puzzles
with these themes.

\begin{figure}[H]
    \begin{minipage}{0.475\textwidth}
        \centering
        \includegraphics[width=\textwidth]{project/img/puzzle_histogram.png}
        \caption{Distribution of lichess.org puzzle ratings.}
        \label{dataHistogram}
    \end{minipage}
    \hspace{0.05\textwidth}
    \begin{minipage}{0.475\textwidth}
        \centering
        \includegraphics[width=\textwidth]{project/img/puzzle_theme_histograms.png}
        \caption{Distribution of lichess.org puzzle ratings with a specific theme.}
        \label{dataThemeHistogram}
    \end{minipage}
\end{figure}

\begin{figure}[H]
    \begin{minipage}{0.475\textwidth}
        \centering
        \chessboard[setfen=6k1/5ppp/r1p5/p1n1rP2/8/2P2N1P/2P3P1/3R2K1 w - - 0 22]
        \caption{\textbf{Kenan2345 -- gandie}, lichess.org Blitz game, move 22. 
        Black loses to \texttt{22.Rd8+}.}
        \label{puzzle3}
    \end{minipage}
    \hspace{0.05\textwidth}
    \begin{minipage}{0.475\textwidth}
        \centering
        \chessboard[setfen=2rq1rk1/7p/1n4pb/1R2Q3/pPpP1P2/P1B5/3N2PP/2R3K1 b - - 0 31]
        \caption{\textbf{mhabib -- Sarg0n}, lichess.org Blitz game, move 31. White loses his queen after \texttt{31...Re38}, as the queen has no safe squares to escape to.}

        \label{puzzle4}
    \end{minipage}
\end{figure}

\section{The Machine Learning Approach}

\subsection{Introduction}

In this section, we describe, analyse, and evaluate a novel approach to the
specific problem of chess puzzle classification, inspired by the recent
unstoppable advancements in the field of natural language processing.

Earlier, we highlighted a number of papers which seek to find new ways to build
on the naive bitboard
representation,\cite{middlegamePatterns}\cite{chessCNN}\cite{chess2vec} by
exploring new embeddings for chess pieces and chess board squares. All three of
the publications make the crucial point that chess pieces influence each other
on the board, and this has to be taken into account, whether it is by creating
extra features to represent pins and central square control,\cite{chessCNN}
open files and attack squares,\cite{middlegamePatterns} or the hash of the
entire chess board.\cite{chess2vec}

Continuing along the `chess board as a $N\times64$ vector' path and, given how
puzzle tactics rely on the interaction of pieces' locations and attack squares,
it seems natural to explore whether the transformer architecture, as described
in the infamous paper `Attention is All you Need',\cite{attention} can help
extract patterns from static chess positions, which can then be used in the
downstream task of puzzle classification and difficulty rating. Figure
\ref{attentionLinks}, taken from this paper, shows how words/tokens can
influence each other in the transformer encoder. At a high level, chess pieces
and squares interact in a similar way on the chess board -- see Figure
\ref{chessPuzzleLinks} for an example.

Applying transformers to chess has been done before,\cite{chessTransformer} but
as far as we are aware, treating individual chess board squares as embeddings
of tokens/words has not been previously explored.

\begin{figure}[H]
    \begin{minipage}{0.425\textwidth}
        \centering
        \includegraphics[width=\textwidth]{project/img/attention.png}
        \caption{Example of attention mechanism in the encoder. Taken from `Attention Is All You Need'.\cite{attention}}
        \label{attentionLinks}
    \end{minipage}
   \hspace{0.05\textwidth}
    \begin{minipage}{0.475\textwidth}
        \centering
        \chessboard[setfen=r3r1n1/bp6/p2p2kp/3N4/2P3n1/1PQ3Pq/P4P2/4RRK1 w - - 0 1,
                    pgfstyle=border,markfields={d5},
                    pgfstyle=straightmove,markmoves={f4-g6,f4-h3,c7-a8,c7-e8,d5-c7,d5-f4},
                    pgfstyle=color,opacity=0.5,color=blue,markfields={f4,c7},
                    pgfstyle=color,opacity=0.5,color=red,markfields={h3,g6,a8,e8}]
        \caption{Example of a relationship between chess pieces.}

        \label{chessPuzzleLinks}
    \end{minipage}
\end{figure}

\subsection{Data Preparation}

We formulate the problem of chess puzzle analysis as a multi-label
classification problem. Given a chess puzzle position in bitboard format,
i.e.\@ a $12\times8\times8$ binary tensor, we aim to predict a binary indicator
vector which encodes the labels of the puzzle themes. Slightly more formally,
the element $B[p, r, f]$ of bitboard $B$ is $1$ iff there is a piece $z \in
\{p,P,n,N,b,B,r,R,q,Q,k,K\}$\footnote{FEN-inspired -- white pieces are
uppercase, black pieces are lowercase.} at rank $r \in \{1,2,3,4,5,6,7,8\}$,
file $f \in \{a,b,c,d,e,f,g,h\}$.

Given a dataset with $N$ distinct puzzle labels ($N=60$ for the Lichess puzzle
database \cite{lichessPuzzles}), we assign each label an index $i$ and form a
binary $N$-dimensional vector $x$ such that $x[i]=1$ iff the puzzle is labelled
with that label. This is a common technique to reduce a multi-label
classification into a more tractable problem.

To make learning easier (and to decrease implementation complexity), we
transform all chess positions to be from the perspective of White. This has
negligible additional overhead, as it requires a simple mirror and has great
benefits, as the model no longer needs to distinguish between white-to-move and
black-to-move puzzles.

\subsection{Model Architecture}

\begin{figure}[H]
        \centering
        \includegraphics[width=\textwidth]{project/img/ml_diagram.png}
        \caption{High-level overview of the model architecture. Transformer encoder diagram taken from `Attention Is All You Need'.\cite{attention}}
        \label{MLDiagram}
\end{figure}


